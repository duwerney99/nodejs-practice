name: Main Flow

on:
    push:
        branches:
            - 'master'
            - 'testing'
            - 'dev'

env:
    SERVICE_NAME: ${{ github.event.repository.name }}
    REGION: us-central1

jobs:
    build_and_deploy:
        runs-on: ubuntu-latest
        name: Build and deploy
        outputs:
            url: ${{ steps.extract_url.outputs.url }}
            branch: ${{ steps.extract_branch.outputs.branch }}
        steps:
            - name: Checkout
              uses: actions/checkout@v2

            - name: Extract branch name
              id: extract_branch
              run: echo "##[set-output name=branch;]$(echo ${GITHUB_REF#refs/heads/})"
              shell: bash

            - name: Set branch-based environment variables
              uses: iamtheyammer/branch-env-vars@v1.0.3
              with:
                  GCP_PROJECT: |
                      master:${{ secrets.PROJECT_ID_PROD }}
                      !default:${{ secrets.PROJECT_ID_TEST }}
                  ENV_FILE: |
                      master:ENV_PROD
                      !default:ENV_DEV

            - name: Cache node modules
              uses: actions/cache@v2
              with:
                  path: '**/node_modules'
                  key: ${{ runner.os }}-modules-${{ hashFiles('**/yarn.lock') }}

            - name: Install and Build
              uses: ./.github/actions/build

            - name: Create ENV File
              run: echo ${{ secrets[env.ENV_FILE] }} | base64 --decode > .env

            - name: Set up Cloud SDK
              uses: google-github-actions/setup-gcloud@v2
              with:
                  project_id: ${{ env.GCP_PROJECT }}
                  service_account_key: ${{ secrets.GCP_SA_KEY }}
                  export_default_credentials: true

            - name: Authenticate to Google Cloud
              run: |
                echo "${{ secrets.GCP_SA_KEY }}" > "${HOME}/gcloud-service-key.json"
                cat "${HOME}/gcloud-service-key.json"
                gcloud auth activate-service-account --key-file="${HOME}/gcloud-service-key.json"

            - name: Build and deploy image
              run: |
                PROJECT_ID=${{ env.GCP_PROJECT }} 
                COMMIT_SHA=${{ github.sha }} 
                SERVICE_NAME=${{ env.SERVICE_NAME }} 
                make deploy

            - name: Deploy to Cloud Run
              run: |
                  gcloud run deploy $SERVICE_NAME \
                    --image gcr.io/$GCP_PROJECT/$SERVICE_NAME:${{ github.sha }} \
                    --allow-unauthenticated \
                    --region $REGION \
                    --max-instances 2

            - name: Get URL Cloud Run
              id: extract_url
              run: echo "##[set-output name=url;]$(gcloud run services describe $SERVICE_NAME --platform managed --region $REGION --format 'value(status.url)')"
              shell: bash
